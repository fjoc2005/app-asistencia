<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrador - APP Asistencia</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@700;800&display=swap"
        rel="stylesheet">

    <script src="version-control.js"></script>
    <script>
        document.write('<link rel="stylesheet" href="styles.css?v=' + new Date().getTime() + '">');
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
</head>

<body class="admin-page">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="header-logo-group">
                    <div class="logo-icon-small">
                        <i data-lucide="clipboard-check"></i>
                    </div>
                    <h3>SINTRAMAE</h3>
                </div>
                <button class="btn-icon sidebar-toggle" onclick="toggleSidebar()">
                    <i data-lucide="menu"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-item active" onclick="showView('dashboard')">
                    <i data-lucide="layout-dashboard"></i>
                    <span class="nav-text">Dashboard</span>
                </a>
                <a href="#control-asistencia" class="nav-item" onclick="showView('controlAsistencia')">
                    <i data-lucide="clipboard-check"></i>
                    <span class="nav-text">Control de Asistencia</span>
                </a>
                <a href="#nomina-socias" class="nav-item" onclick="showView('nominaSocias')">
                    <i data-lucide="users"></i>
                    <span class="nav-text">Nómina de Socias</span>
                </a>
                <a href="#justificaciones" class="nav-item" onclick="showView('justificaciones')">
                    <i data-lucide="file-text"></i>
                    <span class="nav-text">Justificaciones</span>
                </a>
                <a href="#vinculacion" class="nav-item" onclick="showView('vinculacion')">
                    <i data-lucide="cloud"></i>
                    <span class="nav-text">Vinculación</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i data-lucide="log-out"></i>
                    Cerrar Sesión
                </button>
                <div class="branding-footer">
                    Desarrollado para <strong>Sintramae</strong>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <h1 id="viewTitle">Dashboard</h1>
                <div class="admin-user">
                    <i data-lucide="user-circle"></i>
                    <span id="adminEmail">administracion@gmail.com</span>
                </div>
            </header>

            <!-- Dashboard View -->
            <div id="dashboardView" class="view-content active">
                <div class="dashboard-actions" style="margin-bottom: 2rem; display: flex; justify-content: flex-start;">
                    <button class="btn-primary" onclick="showEnrolarModal()">
                        <i data-lucide="qr-code"></i>
                        Enrolar Nuevo Usuario
                    </button>
                    <!-- More left-aligned actions can go here -->
                </div>

                <div class="stats-grid">
                    <div class="stat-card animate-scale-in" style="animation-delay: 0.1s; cursor: pointer;"
                        onclick="showView('nominaSocias')">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i data-lucide="users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalSocias">0</h3>
                            <p>Total Socias</p>
                        </div>
                    </div>

                    <div class="stat-card animate-scale-in" style="animation-delay: 0.2s; cursor: pointer;"
                        onclick="showView('controlAsistencia'); showControlTab('matriz');">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i data-lucide="calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="asistenciasHoy">0</h3>
                            <p>Asistencias Hoy</p>
                        </div>
                    </div>

                    <div class="stat-card animate-scale-in" style="animation-delay: 0.3s; cursor: pointer;"
                        onclick="showView('controlAsistencia'); showControlTab('reuniones');">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i data-lucide="calendar"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalReuniones">0</h3>
                            <p>Reuniones Activas</p>
                        </div>
                    </div>

                    <div class="stat-card animate-scale-in" style="animation-delay: 0.4s;">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="asistenciaPromedio">0%</h3>
                            <p>Asistencia Promedio</p>
                        </div>
                    </div>
                </div>

                <div class="recent-activity" style="margin-top: 2rem;">
                    <h2><i data-lucide="activity"></i> Actividad Reciente</h2>
                    <div id="recentActivityList" class="activity-list">
                        <p class="empty-state">No hay actividad reciente</p>
                    </div>
                </div>
            </div>

            <!-- Control de Asistencia View -->
            <div id="controlAsistenciaView" class="view-content">
                <div class="control-tabs">
                    <button class="tab-btn active" onclick="showControlTab('matriz')">Matriz de Asistencia</button>
                    <button class="tab-btn" onclick="showControlTab('reuniones')">Gestión de Reuniones</button>
                </div>

                <!-- Matriz de Asistencia Tab -->
                <div id="matrizTab" class="control-tab-content active">
                    <div class="view-header">
                        <h2>Matriz de Asistencia</h2>
                        <div class="legend">
                            <span class="legend-item"><span class="badge-asistio">✓</span> Asistió</span>
                            <span class="legend-item"><span class="badge-no-asistio">✗</span> No asistió</span>
                            <span class="legend-item"><span class="badge-justifico">J</span> Justificó</span>
                        </div>
                    </div>

                    <div class="attendance-matrix-container">
                        <table class="attendance-matrix" id="attendanceMatrix">
                            <thead>
                                <tr>
                                    <th class="sticky-col">Socia</th>
                                    <!-- Meeting columns will be added dynamically -->
                                </tr>
                            </thead>
                            <tbody id="matrixBody">
                                <tr>
                                    <td colspan="100" class="empty-state">No hay datos para mostrar. Crea reuniones y
                                        agrega socias.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reuniones Tab -->
                <div id="reunionesTab" class="control-tab-content">
                    <div class="view-header">
                        <h2>Gestión de Reuniones</h2>
                        <button class="btn-primary" onclick="showNuevaReunionModal()">
                            <i data-lucide="plus"></i>
                            Nueva Reunión
                        </button>
                    </div>

                    <div class="meetings-grid" id="meetingsGrid">
                        <p class="empty-state">No hay reuniones registradas</p>
                    </div>
                </div>
            </div>

            <!-- Nómina de Socias View -->
            <div id="nominaSociasView" class="view-content">
                <div class="view-header">
                    <div class="search-bar">
                        <i data-lucide="search"></i>
                        <input type="text" id="searchSocias" placeholder="Buscar por RUT o nombre...">
                    </div>
                    <div class="header-actions">
                        <button class="btn-secondary" onclick="showImportarModal()">
                            <i data-lucide="file-spreadsheet"></i>
                            Importar Excel
                        </button>
                        <button class="btn-secondary" onclick="showVoiceAssistantModal()"
                            style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white;">
                            <i data-lucide="mic"></i>
                            Agregar por Voz
                        </button>
                        <button class="btn-danger" onclick="deleteAllSocias()">
                            <i data-lucide="trash-2"></i>
                            Eliminar Todas
                        </button>
                        <button class="btn-primary" onclick="showNuevaSociaModal()">
                            <i data-lucide="user-plus"></i>
                            Nueva Socia
                        </button>
                        <button class="btn-success" onclick="manualSaveSocias()"
                            style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                            <i data-lucide="save"></i>
                            Guardar Info
                        </button>
                    </div>
                </div>

                <div class="table-tabs-container">
                    <div class="table-tabs">
                        <button class="table-tab active" onclick="filterTableColumns('all')">Todo</button>
                        <button class="table-tab" onclick="filterTableColumns('basico')">Básico</button>
                        <button class="table-tab" onclick="filterTableColumns('contacto')">Contacto</button>
                        <button class="table-tab" onclick="filterTableColumns('personal')">Personal</button>
                        <button class="table-tab" onclick="filterTableColumns('laboral')">Institucional</button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th class="sticky-col">Acciones</th>
                                <th onclick="sortTable('numReg')" class="sortable">N° REG <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('rut')" class="sortable">RUT <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('nombres')" class="sortable">Nombres <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('apellidoPaterno')" class="sortable">Ap. Paterno <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('apellidoMaterno')" class="sortable">Ap. Materno <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('comuna')" class="sortable">Comuna <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('numRegAnt')" class="sortable">Reg. Ant <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('fechaNacimiento')" class="sortable">F. Nac <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('edad')" class="sortable">Edad <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('estadoCivil')" class="sortable">Est. Civil <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('celular')" class="sortable">Celular <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('direccion')" class="sortable">Dirección <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('email')" class="sortable">Email <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('rbd')" class="sortable">RBD <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('anoIngresoPae')" class="sortable">Año PAE <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('hijosMenores')" class="sortable">H. Menores <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('hijosMayores')" class="sortable">H. Mayores <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('empresa')" class="sortable">Empresa <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th onclick="sortTable('estado')" class="sortable">Estado <i
                                        data-lucide="chevrons-up-down"></i></th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="sociasTableBody">
                            <tr>
                                <td colspan="20" class="empty-state">No hay socias registradas</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vinculación de Cuentas View -->
            <div id="vinculacionView" class="view-content">
                <div class="view-header">
                    <h2>Vinculación de Cuentas</h2>
                    <p class="subtitle">Conecta tu cuenta de Google Drive para sincronizar y respaldar datos</p>
                </div>

                <!-- Connection Status Card -->
                <div class="drive-card" id="driveStatusCard">
                    <div class="drive-card-header">
                        <h3><i data-lucide="link"></i> Estado de Conexión</h3>
                    </div>
                    <div class="drive-card-body">
                        <div class="drive-status">
                            <span class="status-indicator" id="driveStatusIndicator">❌</span>
                            <div class="status-info">
                                <span class="status-text disconnected" id="driveStatusText">Desconectado</span>
                                <span class="status-email" id="driveUserEmail" style="display: none;"></span>
                                <span class="status-folder" id="driveFolderStatus" style="display: none;"></span>
                            </div>
                        </div>
                        <div class="drive-actions">
                            <button class="btn-primary" id="driveConnectBtn" onclick="driveIntegration?.signIn()">
                                <i data-lucide="log-in"></i>
                                Conectar con Google Drive
                            </button>
                            <button class="btn-secondary" id="driveDisconnectBtn" onclick="driveIntegration?.signOut()"
                                style="display: none;">
                                <i data-lucide="log-out"></i>
                                Desconectar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sync Settings Card -->
                <div class="drive-card">
                    <div class="drive-card-header">
                        <h3><i data-lucide="settings"></i> Configuración de Sincronización</h3>
                    </div>
                    <div class="drive-card-body">
                        <div class="setting-item">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoSyncToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="setting-info">
                                <span class="setting-label">Sincronización automática</span>
                                <span class="setting-description">Sincroniza automáticamente al modificar datos</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label class="toggle-switch">
                                <input type="checkbox" id="dailyBackupToggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <div class="setting-info">
                                <span class="setting-label">Backup diario</span>
                                <span class="setting-description">Crea un respaldo automático cada día</span>
                            </div>
                        </div>
                        <div class="drive-manual-actions">
                            <button class="btn-primary" id="driveSyncBtn"
                                onclick="driveIntegration?.exportSociasToSheets()" disabled>
                                <i data-lucide="refresh-cw"></i>
                                Sincronizar ahora
                            </button>
                            <button class="btn-secondary" id="driveExportBtn"
                                onclick="driveIntegration?.exportSociasToSheets()" disabled>
                                <i data-lucide="upload"></i>
                                Exportar a Sheets
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Justificaciones View -->
            <div id="justificacionesView" class="view-content">
                <div class="view-header">
                    <h2>Justificaciones de Inasistencias</h2>
                    <p class="subtitle">Registra justificaciones para ausencias en reuniones</p>
                </div>

                <div class="justificaciones-form"
                    style="background: var(--white); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md);">
                    <div class="form-group">
                        <label for="justSociaSelect">Seleccionar Socia</label>
                        <select id="justSociaSelect" class="form-control"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 1rem;">
                            <option value="">-- Seleccionar socia --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="justReunionSelect">Seleccionar Reunión</label>
                        <select id="justReunionSelect" class="form-control"
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 1rem;">
                            <option value="">-- Seleccionar reunión --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="justMotivo">Motivo de Justificación</label>
                        <textarea id="justMotivo" rows="4" placeholder="Ingrese el motivo de la justificación..."
                            style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 1rem; resize: vertical;"></textarea>
                    </div>

                    <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="btn-secondary" onclick="limpiarFormularioJustificacion()">Limpiar</button>
                        <button class="btn-primary" onclick="guardarJustificacion()">
                            <i data-lucide="save"></i>
                            Guardar Justificación
                        </button>
                    </div>
                </div>

                <div class="justificaciones-list" style="margin-top: 2rem;">
                    <h3>Justificaciones Registradas</h3>
                    <div id="justificacionesTableContainer" class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Socia</th>
                                    <th>Reunión</th>
                                    <th>Fecha</th>
                                    <th>Motivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="justificacionesTableBody">
                                <tr>
                                    <td colspan="5" class="empty-state">No hay justificaciones registradas</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nueva Reunión -->
    <div id="nuevaReunionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Reunión</h3>
                <button class="btn-close" onclick="closeModal('nuevaReunionModal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="nuevaReunionForm">
                <div class="form-group">
                    <label for="reunionNombre">Nombre de la Reunión</label>
                    <input type="text" id="reunionNombre" placeholder="Reunión Mensual Enero" required>
                </div>
                <div class="form-group">
                    <label for="reunionFecha">Fecha</label>
                    <input type="date" id="reunionFecha" required>
                </div>
                <div class="form-group">
                    <label for="reunionHora">Hora</label>
                    <input type="time" id="reunionHora" required>
                </div>
                <div class="form-group">
                    <label for="reunionDescripcion">Descripción</label>
                    <textarea id="reunionDescripcion" rows="3" placeholder="Descripción de la reunión"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('nuevaReunionModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Crear Reunión</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nueva Socia -->
    <div id="nuevaSociaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nueva Socia</h3>
                <button class="btn-close" onclick="closeModal('nuevaSociaModal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="nuevaSociaForm">
                <p style="color: var(--gray-600); margin-bottom: 1.5rem; font-size: 0.9rem;">
                    <i data-lucide="info" style="width: 16px; height: 16px; vertical-align: middle;"></i>
                    Solo el RUT es obligatorio. Los demás datos pueden completarse después en la nómina de socias.
                </p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="sociaRut">RUT *</label>
                        <input type="text" id="sociaRut" placeholder="12.345.678-9" required autofocus>
                    </div>
                </div>

                <div class="form-row"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div class="form-group">
                        <label for="sociaNombres">Nombres</label>
                        <input type="text" id="sociaNombres" placeholder="Ej: María José">
                    </div>
                    <div class="form-group">
                        <label for="sociaTelefono">Teléfono/WhatsApp</label>
                        <input type="text" id="sociaTelefono" placeholder="Ej: +56912345678">
                    </div>
                </div>

                <div class="form-row"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; margin-bottom: 1.5rem;">
                    <div class="form-group">
                        <label for="sociaApellidoPaterno">Apellido Paterno</label>
                        <input type="text" id="sociaApellidoPaterno" placeholder="Ej: González">
                    </div>
                    <div class="form-group">
                        <label for="sociaApellidoMaterno">Apellido Materno</label>
                        <input type="text" id="sociaApellidoMaterno" placeholder="Ej: Pérez">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('nuevaSociaModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Socia</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar Excel -->
    <div id="importarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Importar Socias desde Excel</h3>
                <button class="btn-close" onclick="closeModal('importarModal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="import-section">
                <div class="upload-area" id="uploadArea">
                    <i data-lucide="upload-cloud"></i>
                    <h3>Arrastra tu archivo Excel aquí</h3>
                    <p>o haz clic para seleccionar</p>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                    <button class="btn-secondary" onclick="document.getElementById('excelFile').click()">
                        Seleccionar Archivo
                    </button>
                </div>

                <div class="csv-format-info">
                    <h3>Formato del Excel</h3>
                    <p>El archivo debe contener las siguientes columnas:</p>
                    <code>Apellido Paterno | Apellido Materno | Nombres | Teléfono | RUT</code>
                    <p class="example">Ejemplo: González | Pérez | María José | 912345678 | 12345678-9</p>
                    <button class="btn-primary" onclick="downloadExcelTemplate()" style="margin-top: 1rem;">
                        <i data-lucide="download"></i> Descargar Plantilla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Enrolar (QR) -->
    <div id="enrolarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enrolar Nuevo Usuario</h3>
                <button class="btn-close" onclick="closeEnrolarModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="enrolar-body">
                <p class="instruction-text">Escanea el código QR del carnet de identidad para autocompletar los datos.
                </p>

                <div id="enrolarReader"
                    style="width: 100%; min-height: 300px; border-radius: 12px; overflow: hidden; margin-bottom: 1rem;">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeEnrolarModal()">Cancelar</button>
                    <button type="button" class="btn-ghost"
                        onclick="closeEnrolarModal(); showNuevaSociaModal();">Entrada Manual</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Asistencia -->
    <div id="editarAsistenciaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Asistencia</h3>
                <button class="btn-close" onclick="closeModal('editarAsistenciaModal')">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <form id="editarAsistenciaForm">
                <input type="hidden" id="editSociaRut">
                <input type="hidden" id="editReunionId">

                <div class="form-group">
                    <p><strong>Socia:</strong> <span id="editSociaNombre"></span></p>
                    <p><strong>Reunión:</strong> <span id="editReunionNombre"></span></p>
                </div>

                <div class="form-group">
                    <label for="editEstadoAsistencia">Estado de Asistencia</label>
                    <select id="editEstadoAsistencia" required>
                        <option value="">-- Seleccionar --</option>
                        <option value="asistio">✓ Asistió</option>
                        <option value="no-asistio">✗ No asistió</option>
                        <option value="justifico">J Justificó</option>
                    </select>
                </div>

                <div class="form-group" id="justificacionGroup" style="display: none;">
                    <label for="editJustificacion">Justificación</label>
                    <textarea id="editJustificacion" rows="3" placeholder="Ingresa la justificación..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary"
                        onclick="closeModal('editarAsistenciaModal')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Assistant Reminder Bubble -->
    <div class="ai-reminder-bubble" id="aiReminderBubble" style="display: none;">
        <button class="ai-bubble-close" onclick="closeAIBubble()">
            <i data-lucide="x"></i>
        </button>
        <div class="ai-bubble-content">
            <div onclick="toggleAIChat()" style="display:flex; align-items:center; gap:10px;">
                <img src="https://ui-avatars.com/api/?name=Asistente+AI&background=random&gender=female" alt="AI Avatar"
                    class="ai-avatar-small">
                <div class="ai-text-content">
                    <p class="ai-bubble-title">¡Hola!</p>
                    <p class="ai-bubble-message">¿Necesitas ayuda?</p>
                </div>
            </div>
            <button onclick="showEnrolarModal()" class="btn-xs btn-primary"
                style="margin-left: 10px; padding: 4px 8px; font-size: 0.7rem;">
                <i data-lucide="qr-code" style="width: 14px; height: 14px;"></i> Enrolar
            </button>
        </div>
    </div>

    <!-- AI Assistant Chat -->
    <button class="ai-chat-button" id="aiChatButton" onclick="toggleAIChat()">
        <i data-lucide="sparkles"></i>
        <div class="ai-badge">IA</div>
    </button>

    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-header">
            <h3><i data-lucide="bot"></i> Asistente IA</h3>
            <button class="btn-close" onclick="toggleAIChat()">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message assistant">
                <div class="message-content">
                    ¡Hola! Soy <strong>Teresita</strong>, tu asistente virtual. Estoy aquí para ayudarte con la gestión
                    de SINTRAMAE. ¿Qué necesitas hacer hoy?
                </div>
            </div>
        </div>

        <div class="ai-quick-actions" id="aiQuickActions">
            <button class="quick-action-chip" onclick="sendQuickAction('Crear nueva reunión')">
                <i data-lucide="calendar-plus"></i> Crear reunión
            </button>
            <button class="quick-action-chip" onclick="sendQuickAction('Agregar nueva socia')">
                <i data-lucide="user-plus"></i> Agregar nueva socia
            </button>
            <button class="quick-action-chip" onclick="sendQuickAction('Reporte individual')">
                <i data-lucide="file-text"></i> Reporte
            </button>
        </div>

        <div class="ai-typing-indicator" id="aiTypingIndicator" style="display: none;">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Escribe un mensaje..."
                onkeypress="handleAIChatKeyPress(event)">
            <button class="btn-send" onclick="sendAIMessage()">
                <i data-lucide="send"></i>
            </button>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- Lazy Loader Utility -->
    <script src="js/utils/lazy-loader.js"></script>

    <!-- Error Handler (carga inmediata, es pequeño y crítico) -->
    <script src="js/services/error-handler.js"></script>

    <!-- Admin Core (carga inmediata) -->
    <script>
        const ts = new Date().getTime();
        document.write('<script src="admin.js?v=' + ts + '"><\/script>');
    </script>

    <!-- Lazy Loading de módulos pesados -->
    <script>
        // Pre-cargar módulos en segundo plano cuando el navegador esté idle
        if (typeof lazyLoader !== 'undefined') {
            lazyLoader.preload([
                { src: 'google-drive-integration.js', id: 'drive-integration' },
                { src: 'ai-assistant.js', id: 'ai-assistant' }
            ]);
        }
    </script>

    <script>
        lucide.createIcons();
    </script>

    <!-- ✨ NUEVOS SERVICIOS ✨ -->
    <script src="js/services/meeting-attendance.js"></script>
    <script src="js/services/discount-manager.js"></script>

    <!-- MODALES NUEVOS -->
    <!-- Modal Nuevo Descuento -->
    <div id="modalNuevoDescuento" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Descuento - <span id="descuentoSociaNombre"></span></h3>
                <button class="btn-icon" onclick="document.getElementById('modalNuevoDescuento').style.display='none'">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <input type="hidden" id="descuentoSociaRut">

            <form onsubmit="event.preventDefault(); guardarNuevoDescuento();">
                <div class="form-group">
                    <label>Comercio/Entidad:</label>
                    <input type="text" id="descuentoComercio" required class="form-control">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Monto Total:</label>
                        <input type="number" id="descuentoMonto" required class="form-control" min="0">
                    </div>

                    <div class="form-group">
                        <label>Número de Cuotas:</label>
                        <input type="number" id="descuentoCuotas" required class="form-control" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label>Fecha Inicio:</label>
                    <input type="date" id="descuentoFecha" required class="form-control">
                </div>

                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="descuentoObservaciones" class="form-control" rows="3"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="submit" class="btn-primary">
                        <i data-lucide="save"></i> Guardar Descuento
                    </button>
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('modalNuevoDescuento').style.display='none'">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Estado Socia -->
    <div id="modalEstadoSocia" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Historial de Descuentos - <span id="estadoSociaNombre"></span></h3>
                <button class="btn-icon" onclick="document.getElementById('modalEstadoSocia').style.display='none'">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0;">
                <div class="stat-card">
                    <h4 id="estadoDeudaTotal">$0</h4>
                    <p>Deuda Total Vigente</p>
                </div>
                <div class="stat-card">
                    <h4 id="estadoDescuentosVigentes">0</h4>
                    <p>Descuentos Activos</p>
                </div>
                <div class="stat-card">
                    <h4 id="estadoDescuentosFinalizados">0</h4>
                    <p>Descuentos Finalizados</p>
                </div>
            </div>

            <h4>Historial Completo</h4>
            <div id="historialDescuentosContainer"></div>
        </div>
    </div>

    <!-- Modal Justificar Asistencia -->
    <div id="modalJustificar" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Justificar Ausencia</h3>
                <button class="btn-icon" onclick="document.getElementById('modalJustificar').style.display='none'">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <input type="hidden" id="justificarMeetingId">
            <input type="hidden" id="justificarSociaRut">

            <p><strong>Socia:</strong> <span id="justificarSociaNombre"></span></p>

            <div class="form-group">
                <label>Motivo de la justificación:</label>
                <textarea id="justificarMotivo" class="form-control" rows="4" required></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn-primary" onclick="guardarJustificacion()">
                    <i data-lucide="check"></i> Guardar Justificación
                </button>
                <button class="btn-secondary" onclick="document.getElementById('modalJustificar').style.display='none'">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- New Modules Scripts -->
    <script src="voice-assistant.js"></script>
    <script src="pdf-generator.js"></script>
    <script src="excel-importer.js"></script>

</body>

</html>